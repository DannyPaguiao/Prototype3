<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Bejewler</title>
		<script src="jquery.js"></script>
		<script src="underscore.js"></script>
		<script src="three.min.js"></script>
	</head>
	<body>
		<p>
			Bejewler
		</p>
		<script>
			// Convert board position into world position
			var board_to_world = function(position) {

				return {
					x : 100 * position.x,
					y : 100 * position.y,
					z : 0
				};

			};
		

			// Barrier class
			var Barrier = function(position) {
				this.isEmpty = false;
				this.boardPosition = position || {
					x : 0,
					y : 0
				};
				this.type = 'barrier';
				this.geometry = new THREE.CubeGeometry(90, 90, 90);
				// Geometry should always be around origin
				this.material = new THREE.MeshLambertMaterial({
					color : 0xff0000
				});
				this.object = new THREE.Mesh(this.geometry, this.material);
				// A mesh is an Object3D, change its position to move
				this.object.position = board_to_world(this.boardPosition);
			};

			Barrier.prototype.updateBoardPosition = function() {
				this.object.position = board_to_world(this.boardPosition);
			};

			var Gem = function(position) {
				//// A Barrier is a game object
				// Default position if unspecified is at square 0, 0
				this.isEmpty = false;
				this.boardPosition = position || {
					x : 0,
					y : 0
				};
				this.type = 'gem';
				this.geometry = new THREE.CubeGeometry(90, 90, 90);
				// Geometry should always be around origin
				this.material = new THREE.MeshLambertMaterial({
					color : 0x0fff00
				});
				this.object = new THREE.Mesh(this.geometry, this.material);
				// A mesh is an Object3D, change its position to move
				this.object.position = board_to_world(this.boardPosition);
			};

			Gem.prototype.moveTo = function(position) {
				this.boardPosition = position;
				this.updateBoardPosition();
			};

			Gem.prototype.updateBoardPosition = function() {
				this.object.position = board_to_world(this.boardPosition);
			};

			var Robot = function(position) {
				//// A Robot is a game object
				// Default position if unspecified is at square 0, 0
				this.boardPosition = position || {
					x : 0,
					y : 0
				};
				this.type = 'robot';
				this.geometry = new THREE.SphereGeometry(45, 20, 20);
				// Geometry should always be around origin
				// Make it blue
				this.material = new THREE.MeshPhongMaterial({
					color : 0x0000ff
				});
				this.object = new THREE.Mesh(this.geometry, this.material);

				// A mesh is an Object3D, change its position to move
				this.object.position = board_to_world(this.boardPosition);

			};

			Robot.prototype.updateBoardPosition = function() {
				this.object.position = board_to_world(this.boardPosition);
			};

			Robot.prototype.moveTo = function(position) {
				this.boardPosition = position;
				this.updateBoardPosition();
			};

			var Game = function() {
				// A Game object is the highest level object representing entire game
			};

			Game.prototype.init = function() {
				var that = this;
				
				this.facing = 'up';

				this.virtualBoard = new Array(7);
				for (var i = 0; i < 7; i++) {
					this.virtualBoard[i] = [{},{},{},{},{},{},{}];

				}

				this.startingBoard = [['0', '0', '0', '0', '0', '0', '0'], // create a board where true = occupied by a block
									  ['0', '2', '2', '1', '1', '0', '0'], // and where '1' = empty spot
									  ['0', '0', '0', '0', '0', '0', '0'], 
									  ['0', '1', '1', '2', '2', '0', '0'], 
									  ['0', '0', '0', '0', '0', '0', '0'], 
									  ['0', '0', '0', '0', '0', '0', '0'], 
									  ['0', '0', '0', '0', '0', '0', '0']];
				
				
				for (var x = 0; x < 7; x++) {
					for (var y = 0; y < 7; y++) {
						
				
						// If there is a 1 in startingBoard create a barrier object
						if (this.startingBoard[y][x] == '1') {
							this.virtualBoard[y][x] = new Barrier({
								x : (x - 3),
								y : -(y - 3)
							});
						}

						// If there is a 2 in startingBoard create a gem object
						if (this.startingBoard[y][x] == '2') {
							this.virtualBoard[y][x] = new Gem({
								x : (x - 3),
								y : -(y - 3)
							});
						}
						// If there is a 0 in startingBoard set the slot's isEmpty property to true'
						if (this.startingBoard[y][x] == '0') {
							// For every slot in the board create an object Slot

							this.virtualBoard[y][x].isEmpty = true;
						}

					}
				}

				this.robot = new Robot({
					x : -2,
					y : -3
				});
				// create a new robot

				this.camera = new THREE.PerspectiveCamera(75, 4.0 / 3.0, 1, 10000);
				this.camera.position.z = 550;

				this.scene = new THREE.Scene();

				for (var x = 0; x < 7; x++) {
					for (var y = 0; y < 7; y++) {

						if (this.startingBoard[x][y] == '1' || this.startingBoard[x][y] == '2') {
							that.scene.add(this.virtualBoard[x][y].object);
						}
					}
				}

				this.scene.add(this.robot.object);
				// add robot to scene

				// Spotlight
				var spotlight = new THREE.PointLight(0xffffff, 1, 1000);
				spotlight.position.set(0, -100, 400);
				this.scene.add(spotlight);
				// Ambient light
				var ambient_light = new THREE.AmbientLight(0x202020);
				this.scene.add(ambient_light);
				// Background plane
				var bgplane = new THREE.Mesh(new THREE.PlaneGeometry(800, 700), new THREE.MeshLambertMaterial());
				bgplane.translateZ(-100);
				this.scene.add(bgplane);

				this.renderer = new THREE.WebGLRenderer({
					antialias : true
				});
				this.renderer.setSize(800, 600);
				this.renderer.setClearColor(0xeeeeee, 1.0);
				document.body.appendChild(this.renderer.domElement);

				// Setup keyboard events
				this.keys = {};
				$('body').keydown(function(e) {
					if (e.which) {
						if (that.keys[e.which] !== 'triggered') {
							that.keys[e.which] = true;
						}
					}
				});
				$('body').keyup(function(e) {
					if (e.which) {
						that.keys[e.which] = false;
					}
				});
			};

			Game.prototype.render = function(t) {
				// Bob the camera a bit
				this.camera.position.x = 0;
				this.camera.position.y = -300;
				this.camera.lookAt(this.scene.position);
				this.renderer.render(this.scene, this.camera);
			};

			Game.prototype.legalRobotMove = function(position) {
				if (position.x < -3 || position.x > 3) {// check if position that you want to move to is the edge of the board horizontally
					return false;
				}
				if (position.y < -3 || position.y > 3) {// check if position that you want to move to is the edge of the board vertically
					return false;
				}
				if (this.virtualBoard[-position.y + 3][position.x + 3].isEmpty) {
					return true;
				} else {
					return false;
				}
				if(this.virtualBoard[-position.y + 3][position.x + 3].type = 'gem') {
					return false;
				} else{
					return true;
				}
				return true;
			};

			Game.prototype.createGem = function(position){
				
				if(this.virtualBoard[-position.y + 3][position.x + 3].isEmpty){
					this.virtualBoard[position]= new Gem(position);
					this.scene.add(this.virtualBoard[position].object);
					
				}
			};




			Game.prototype.handleInput = function() {

				// Left
				if (this.keys[65] === true) {
					this.keys[65] = 'triggered';
					var newPosition = {
						x : this.robot.boardPosition.x - 1,
						y : this.robot.boardPosition.y
					};

					if (this.legalRobotMove(newPosition)) {
						this.robot.moveTo(newPosition);
						// check neighbors if there's a block
					}
				}
				// Right
				if (this.keys[68] === true) {
					this.keys[68] = 'triggered';
					var newPosition = {
						x : this.robot.boardPosition.x + 1,
						y : this.robot.boardPosition.y
					};
					if (this.legalRobotMove(newPosition)) {
						this.robot.moveTo(newPosition);
					}
				}
				// Up
				if (this.keys[87] === true) {
					this.keys[87] = 'triggered';
					var newPosition = {
						x : this.robot.boardPosition.x,
						y : this.robot.boardPosition.y + 1
					};
					if (this.legalRobotMove(newPosition)) {
						this.robot.moveTo(newPosition);
					}
				}
				// Down
				if (this.keys[83] === true) {
					this.keys[83] = 'triggered';
					var newPosition = {
						x : this.robot.boardPosition.x,
						y : this.robot.boardPosition.y - 1
					};
					if (this.legalRobotMove(newPosition)) {
						this.robot.moveTo(newPosition);
					}
				}
				// Spacebar
				if (this.keys[32] === true){
					this.keys[32] = 'triggered';
					that = this;
					
					// determine what direction character is facing
					var newPosition;
					if(this.facing == 'right'){
					newPosition = {
						x: this.robot.boardPosition.x + 1,
						y: this.robot.boardPosition.y
					};
					}
					if(this.facing == 'up'){
					newPosition = {
						x: this.robot.boardPosition.x,
						y: this.robot.boardPosition.y + 1
					};
					}
					if(this.facing == 'left'){
					newPosition = {
						x: this.robot.boardPosition.x - 1,
						y: this.robot.boardPosition.y
					};
					}
					if(this.facing == 'down'){
					newPosition = {
						x: this.robot.boardPosition.x,
						y: this.robot.boardPosition.y - 1
					};
					}
					
					console.log(this.facing);
					// create a gem where character is facing
					this.createGem(newPosition);
				
					
				}
				
				// Inputs for determining where the character is facing
				// Up arrow key
				if (this.keys[38] === true) {
					this.keys[38] = 'triggered';
					
					this.facing = 'up';	
				}
				// Left arrow key
				if (this.keys[37] === true) {
					this.keys[37] = 'triggered';
					
					this.facing = 'left';		
				}
				// Down arrow key
				if (this.keys[40] === true) {
					this.keys[40] = 'triggered';
					
					this.facing = 'down';	
				}
				// Right arrow key
				if (this.keys[39] === true) {
					this.keys[39] = 'triggered';
					
					this.facing = 'right';	
				}
				
				
				
				
				
			};

			Game.prototype.start = function() {
				var that = this;
				var time0 = new Date().getTime();
				// milliseconds since 1970
				var loop = function() {
					var time = new Date().getTime();
					// Render visual frame
					that.render(time - time0);
					// Respond to user input
					that.handleInput();
					// Loop
					requestAnimationFrame(loop, that.renderer.domElement);
				};
				loop();
			};

			////

			$(function() {

				var game = new Game();
				game.init();
				game.start();

			});

		</script>

	</body>
</html>

